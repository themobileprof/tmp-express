# Certificate System Implementation

This document describes the comprehensive certificate creation and awarding system implemented for TheMobileProf Learning Platform.

## Key Architecture (Puppeteer + HTML Templates)

### Current Approach (Server-Side PDF Generation)
- âœ… **HTML Templates**: Design certificates using standard HTML/CSS
- âœ… **Puppeteer Rendering**: Server-side PDF generation with headless Chrome
- âœ… **Single source of truth**: Templates control all certificate rendering
- âœ… **Easy customization**: Designers can work with familiar HTML/CSS
- âœ… **Professional output**: High-quality PDF certificates
- âœ… **No synchronization issues**: Server fully controls rendering

## Overview

The certificate system automatically generates and awards professional PDF certificates to users upon completion of courses and classes. **Updated to use Puppeteer + HTML templates** for reliable server-side PDF generation with easy customization.

## Architecture

### Core Components

1. **CertificateGenerator** (`src/utils/certificateGenerator.js`)
   - Server-side PDF generation using Puppeteer
   - HTML template rendering with Chrome headless
   - Browser instance reuse for performance
   - Returns PDF file path and metadata

2. **CertificateService** (`src/utils/certificateService.js`)
   - Business logic for certificate awarding
   - Automatic eligibility checking
   - Integration with course/class completion tracking
   - Email notification with PDF download links

3. **Template Engine** (`src/utils/templateEngine.js`)
   - Mustache-style variable substitution
   - Conditional rendering support
   - HTML escaping for security
   - Template: `src/templates/certificates/default-certificate.html`

## Certificate Generation

### Server-Side Rendering Process

1. **HTML Template**: Load HTML certificate template from disk
2. **Data Injection**: Inject certificate data (name, course, date) using template engine
3. **PDF Generation**: Puppeteer renders HTML to PDF with headless Chrome
4. **File Storage**: Save PDF to uploads/certificates/ directory
5. **Database Record**: Store PDF URL in certifications table
6. **Email Notification**: Send email with PDF download link

### Certificate Data Flow

```javascript
// Certificate data generated by service
{
  fileName: 'certificate-uuid.pdf',
  filePath: '/absolute/path/to/certificate.pdf',
  certificateUrl: '/uploads/certificates/certificate-uuid.pdf',
  verificationCode: 'CERT1A2B3C',
  fileSize: 45678
}
```

### HTML Template Features

- **Standard HTML/CSS**: Use familiar web technologies
- **Professional Layout**: A4 landscape format with custom styling
- **Custom Branding**: TheMobileProf colors and typography
- **Responsive Design**: Templates render consistently
- **Print Optimization**: CSS @page rules for PDF output
- **Easy Customization**: Just edit HTML/CSS files
- **Variable Substitution**: {{userName}}, {{courseTitle}}, etc.

### File Storage

- **Location**: `uploads/certificates/`
- **Naming**: `certificate-{uuid}.pdf`
- **URLs**: Served via `/uploads/certificates/{filename}`
- **Format**: High-quality PDF (A4 landscape)

## Automatic Awarding

### Course Completion Certificates

Certificates are automatically awarded when:
- User completes all lessons in a course (progress = 100%)
- Course has certification enabled (`certification` field is not null)
- User hasn't already received a certificate for this course
- All required tests are passed (if applicable)

**Integration Point**: `updateCourseProgressFromLesson()` in `src/routes/lessons.js`

### Class Completion Certificates

Certificates are automatically awarded when:
- User completes a class (progress = 100%)
- Class has certification enabled
- User hasn't already received a certificate for this class

## API Endpoints

### Certificate Management

```
GET    /api/certifications              # List certificates (with filtering)
GET    /api/certifications/:id          # Get certificate details and metadata
PUT    /api/certifications/:id          # Update certificate (admin/instructor)
DELETE /api/certifications/:id          # Delete certificate (admin/instructor)
GET    /api/certifications/verify/:code # Verify certificate by code
GET    /api/certifications/my           # Current user's certificates
GET    /uploads/certificates/:filename  # Download PDF certificate file
```

### Admin Operations

```
GET    /api/certifications/stats        # Certificate statistics
POST   /api/certifications/award        # Manually award certificate
GET    /api/certifications/eligibility/:userId # Check eligibility
POST   /api/certifications/bulk-award  # Bulk certificate awarding
```

## PDF Certificate Generation

### Puppeteer Architecture

Server-side PDF generation provides:

- **Consistent Output**: All certificates render identically
- **Professional Quality**: High-resolution A4 landscape PDFs
- **Server Control**: No client-side dependencies or variations
- **Browser Instance Reuse**: Performance optimization for bulk operations
- **Direct Downloads**: Users receive ready-to-use PDF files

### Generation Process

1. **Template Loading**: Read HTML template from disk
2. **Data Injection**: Apply certificate data using template engine
3. **Browser Rendering**: Puppeteer renders HTML with Chrome
4. **PDF Creation**: Export to A4 landscape PDF format
5. **File Storage**: Save to `uploads/certificates/` directory
6. **Database Update**: Store file path and metadata

## Email Notifications

### Certificate Awarded Email

- **Template**: `certificate-awarded`
- **Triggers**: Automatic awarding or manual awarding
- **Content**:
  - Congratulations message
  - Certificate details (course title, verification code)
  - Direct PDF download link
  - Instructions for saving and sharing certificate

### Email Features

- **Responsive Design**: Mobile-friendly HTML templates
- **Security Notes**: Verification code importance
- **Action Button**: "ðŸ“„ Download Certificate" links to PDF file
- **Professional Branding**: Consistent with platform design

## Verification System

### Certificate Verification

- **Public Endpoint**: `GET /api/certifications/verify/:code`
- **Features**:
  - Validates verification code
  - Checks certificate status and expiry
  - Returns certificate details without sensitive information
  - Public access (no authentication required)

### Verification Codes

- **Format**: `CERT` + 6 random alphanumeric characters
- **Uniqueness**: Guaranteed unique in database
- **Security**: Used for authenticity verification only

## Database Schema

### Certifications Table

```sql
CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  course_id UUID,           -- NULL for manual certificates
  class_id UUID,            -- NULL for course certificates
  certification_name VARCHAR(255) NOT NULL,
  issuer VARCHAR(255) NOT NULL,
  issued_date DATE NOT NULL,
  expiry_date DATE,         -- NULL for permanent certificates
  certificate_url TEXT,     -- Now used for template images (optional)
  verification_code VARCHAR(100) UNIQUE,
  status certification_status DEFAULT 'issued',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE SET NULL,
  FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE SET NULL
);
```

### Status Enum

```sql
CREATE TYPE certification_status AS ENUM ('issued', 'expired', 'revoked');
```

**Note**: The `certificate_url` field now stores the PDF file path (e.g., `/uploads/certificates/certificate-uuid.pdf`) instead of template image URLs.

## Integration Points

### Course Completion Flow

1. User completes lessons â†’ `updateCourseProgressFromLesson()`
2. Progress reaches 100% â†’ Check certificate eligibility
3. Generate PDF certificate with Puppeteer â†’ Store in uploads/certificates/
4. Save metadata to database â†’ Send email notification

### Class Completion Flow

1. User completes class â†’ Similar to course completion
2. Check class certification settings
3. Award certificate if eligible

### Manual Awarding

- **Admin Interface**: Award certificates for special achievements
- **Bulk Operations**: Award multiple certificates at once
- **Custom Certificates**: Certificates not tied to courses/classes

## Security Considerations

### Server-Side Security

- **Data Validation**: All certificate data validated before PDF generation
- **Authentication**: Certificate downloads require proper authorization
- **Authorization**: Users can only download their own certificates
- **Template Security**: HTML templates use escapeHtml() to prevent XSS
- **File Access Control**: PDF files served with proper authentication checks

### Verification System

- **Public Verification**: Limited data exposed through verification endpoint
- **Unique Codes**: Verification codes guaranteed unique
- **No Sensitive Data**: Verification returns only public certificate details

## Performance

### Puppeteer Optimization

- **Browser Reuse**: Single browser instance shared across requests
- **Lazy Initialization**: Browser starts only when first certificate generated
- **Cleanup**: Browser closes gracefully on server shutdown
- **Efficient Rendering**: Headless Chrome optimized for PDF generation

### Scalability

- **File Storage**: PDFs stored in uploads directory (can use CDN/S3)
- **Async Processing**: Certificate generation doesn't block requests
- **Bulk Operations**: Supported through batch certificate awarding
- **Database Indexing**: Verification codes and user_id indexed for fast lookups

## Testing

### Test Script

Run certificate generation tests:

```bash
cd /home/samuel/sites/tmp-mixer/backend
node test-certificates.js
```

### Test Coverage

- PDF generation with Puppeteer
- File creation and storage verification
- Certificate data structure validation
- Verification code uniqueness
- Database operations
- File size and path validation

## Usage Examples

### Automatic Awarding

```javascript
// When course progress reaches 100%
await certificateService.checkAndAwardCourseCertificate(userId, courseId);
```

### Manual Awarding

```javascript
const certificate = await certificateService.manuallyAwardCertificate({
  userId: 'user-uuid',
  courseId: 'course-uuid',
  certificationName: 'Advanced React Development - Certificate of Completion',
  issuer: 'TheMobileProf Learning Platform',
  issuedDate: '2025-11-27'
});
// Returns: { fileName, filePath, certificateUrl, verificationCode, fileSize }
```

### PDF Download

```javascript
// Certificate URL from database points directly to PDF file
const pdfUrl = certificate.certificate_url;  // '/uploads/certificates/certificate-uuid.pdf'
// Users download PDF directly from uploads directory
```

### Verification

```javascript
// GET /api/certifications/verify/CERT123ABC
{
  "valid": true,
  "certificate": {
    "userName": "John Doe",
    "certificationName": "Course Completion Certificate",
    "issuedDate": "2025-11-27",
    "status": "issued"
  }
}
```

## Frontend Integration

Frontend applications should:

1. **List Certificates**: Use `GET /api/certifications/my` to fetch user's certificates
2. **Download PDFs**: Link directly to `certificate_url` field (e.g., `/uploads/certificates/certificate-uuid.pdf`)
3. **Display Metadata**: Show certification name, issue date, verification code, status
4. **Verification**: Link to verification page with verification code

### Example Frontend Code

```javascript
// Fetch user's certificates
const response = await fetch('/api/certifications/my', {
  headers: { 'Authorization': `Bearer ${token}` }
});
const { certifications } = await response.json();

// Display download links
certifications.forEach(cert => {
  const downloadLink = cert.certificate_url; // Points to PDF file
  const verifyLink = `/verify/${cert.verification_code}`;
  // Render UI with download and verify buttons
});
```

## Dependencies

### Required Packages

```json
{
  "puppeteer": "^22.0.0"  // Headless Chrome for PDF generation
}
```

### Installation

```bash
npm install puppeteer
```

**Note**: Puppeteer downloads Chromium automatically (~170MB). In Docker, ensure the image includes Chrome dependencies.

## Future Enhancements

### Potential Features

1. **Multiple Templates**: Support different certificate designs via `src/templates/certificates/`
2. **Digital Signatures**: Integrate electronic signature images
3. **QR Codes**: Embed verification QR codes in certificates
4. **Bulk Operations**: Batch certificate generation with progress tracking
5. **Template Editor**: Admin UI for customizing certificate templates
6. **Internationalization**: Multi-language certificate support

### Technical Improvements

1. **CDN Storage**: Store PDFs in S3/CloudFront instead of local uploads
2. **Async Queue**: Use job queue (Bull/BeeQueue) for certificate generation
3. **Watermarks**: Optional watermark/background image support
4. **PDF Metadata**: Embed metadata (author, title, subject) in PDF files
5. **Template Versioning**: Track template versions for audit trails

## Troubleshooting

### Common Issues

1. **Puppeteer Installation Fails**
   - Ensure Chrome dependencies installed: `apt-get install -y chromium`
   - Docker: Use `node:18` or higher base image
   
2. **PDF Generation Timeout**
   - Increase Puppeteer timeout in generator config
   - Check server resources (CPU/memory)
   
3. **Certificate File Not Found**
   - Verify `uploads/certificates/` directory exists and is writable
   - Check file permissions: `chmod 755 uploads/certificates/`
   
4. **Browser Launch Fails**
   - Docker: Add `--no-sandbox --disable-setuid-sandbox` args to Puppeteer
   - Production: Ensure Chrome/Chromium installed

### Debug Mode

Enable debug logging:

```javascript
// In certificateGenerator.js
const browser = await puppeteer.launch({ 
  headless: true,
  devtools: true,  // Enable for debugging
  dumpio: true     // Log browser console output
});
```

## Conclusion

The certificate system provides a robust, server-side PDF generation solution using Puppeteer and HTML templates. This architecture offers:

- **Reliability**: Consistent PDF output across all environments
- **Flexibility**: Easy template customization with HTML/CSS
- **Professional Quality**: High-resolution A4 landscape certificates
- **Maintainability**: Single source of truth (HTML templates)
- **Scalability**: Browser instance reuse and async processing

The system automatically awards certificates upon course/class completion and integrates seamlessly with email notifications and public verification.</content>
<parameter name="filePath">/home/samuel/sites/tmp-mixer/backend/CERTIFICATE_SYSTEM_README.md