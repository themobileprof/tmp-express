# Payment Endpoints

# Initialize Payment
initialize:
  post:
    operationId: initialize
    tags:
      - Payments
    summary: Initialize Payment
    description: |
      Initialize a payment for course or class enrollment using Flutterwave Standard v3.0.0.
      
      **Special Handling for 100% Discounts:**
      - If a sponsorship code provides 100% discount, the payment is automatically marked as successful
      - No Flutterwave payment is required for free enrollments
      - Enrollment is created immediately
      - Response includes `is_free_enrollment: true` flag
      
      **Payment Flow Logic:**
      1. **Regular Payments**: User provides payment details → Flutterwave payment → Verification → Enrollment
      2. **Free Enrollments**: Sponsorship code with 100% discount → Immediate enrollment → No payment processing
      
      **Response Format:**
      - Free enrollments return `is_free_enrollment: true` with immediate enrollment data
      - Regular payments return `is_free_enrollment: false` with Flutterwave checkout URL
    security:
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - paymentType
              - itemId
            properties:
              paymentType:
                type: string
                enum: [course, class]
                description: Type of item being purchased
              itemId:
                type: string
                format: uuid
                description: ID of the course or class
              paymentMethod:
                type: string
                enum: [card, bank_transfer, ussd, mobile_money, mpesa, gh_mobile_money]
                description: Payment method to use (ignored for free enrollments)
              sponsorshipCode:
                type: string
                description: Optional sponsorship discount code (can result in free enrollment)
              callbackUrl:
                type: string
                description: URL where user will be redirected after payment completion
    responses:
      '200':
        description: Payment initialized successfully
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  properties:
                    success:
                      type: boolean
                      example: true
                    message:
                      type: string
                      example: "Free enrollment successful"
                    data:
                      type: object
                      properties:
                        is_free_enrollment:
                          type: boolean
                          example: true
                          description: Indicates this is a free enrollment (100% discount)
                        enrollment:
                          $ref: '../schemas/Enrollment.yaml'
                          description: Immediately created enrollment for free course/class
                        sponsorship:
                          $ref: '../schemas/Sponsorship.yaml'
                          description: Sponsorship details that provided the free enrollment
                        originalPrice:
                          type: number
                          description: Original price before discount
                        discountAmount:
                          type: number
                          description: Full discount amount (100% of original price)
                        finalPrice:
                          type: number
                          example: 0
                          description: Final price after discount (0 for free enrollments)
                - type: object
                  properties:
                    success:
                      type: boolean
                      example: true
                    message:
                      type: string
                      example: "Payment initialized successfully"
                    data:
                      type: object
                      properties:
                        payment_id:
                          type: string
                          format: uuid
                          description: Internal payment identifier
                        reference:
                          type: string
                          description: Payment reference for tracking
                        flutterwave_reference:
                          type: string
                          description: Flutterwave payment reference
                        checkout_url:
                          type: string
                          description: Flutterwave checkout URL for payment completion
                        original_amount:
                          type: number
                          description: Original price before any discounts
                        final_amount:
                          type: number
                          description: Final amount to pay after discounts
                        discount_amount:
                          type: number
                          description: Amount of discount applied
                        payment_type:
                          type: string
                          enum: [course, class]
                          description: Type of item being purchased
                        sponsorship:
                          type: object
                          properties:
                            id:
                              type: string
                              format: uuid
                            discountCode:
                              type: string
                            discountType:
                              type: string
                              enum: [percentage, fixed]
                            discountValue:
                              type: number
                            discountAmount:
                              type: number
                            originalPrice:
                              type: number
                            finalPrice:
                              type: number
                          description: Sponsorship details if discount code was used
                        is_free_enrollment:
                          type: boolean
                          example: false
                          description: Always false for regular payments
      '400':
        $ref: '../responses/BadRequest.yaml'
      '401':
        $ref: '../responses/Unauthorized.yaml'
      '404':
        $ref: '../responses/NotFound.yaml'
      '409':
        $ref: '../responses/Conflict.yaml'

# Verify Payment
verify:
  get:
    operationId: verify
    tags:
      - Payments
    summary: Verify Payment
    description: |
      Payment verification method. Called by frontend when user returns from Flutterwave.
      
      **Handles Both Payment Types:**
      - **Regular payments**: Verifies with Flutterwave and creates enrollment
      - **Free enrollments (100% discount)**: Already marked as successful, proceeds with enrollment
      
      **Verification Flow:**
      1. **Free Enrollments**: No verification needed, enrollment already exists
      2. **Regular Payments**: Verify with Flutterwave → Confirm payment → Create enrollment
      
      **Note**: This endpoint is primarily for regular payments. Free enrollments are handled
      immediately during initialization and don't require verification.
    security:
      - bearerAuth: []
    parameters:
      - name: reference
        in: path
        required: true
        schema:
          type: string
        description: Payment reference from our system (TMP_...)
    responses:
      '200':
        description: Payment verified and enrollment completed
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  description: Whether verification was successful
                message:
                  type: string
                  description: Success or error message
                payment:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    amount:
                      type: number
                    status:
                      type: string
                    transactionId:
                      type: string
                  description: Payment details (null for free enrollments)
                enrollment:
                  $ref: '../schemas/Enrollment.yaml'
                  description: Created enrollment details
      '400':
        $ref: '../responses/BadRequest.yaml'
      '401':
        $ref: '../responses/Unauthorized.yaml'
      '404':
        $ref: '../responses/NotFound.yaml'

# Get User Payments
getUserPayments:
  get:
    operationId: getUserPayments
    tags:
      - Payments
    summary: Get current user's payment history
    description: |
      Retrieve payment history for the authenticated user.
      
      **Payment Types Included:**
      - Regular payments (with Flutterwave transaction details)
      - Free enrollments (marked with `is_free_enrollment: true`)
      - Failed payments
      - Cancelled payments
    security:
      - bearerAuth: []
    parameters:
      - name: limit
        in: query
        description: Number of results to return
        schema:
          type: integer
          default: 20
          minimum: 1
          maximum: 100
      - name: offset
        in: query
        description: Number of results to skip
        schema:
          type: integer
          default: 0
          minimum: 0
    responses:
      '200':
        description: User payments retrieved successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                payments:
                  type: array
                  items:
                    $ref: '../schemas/Payment.yaml'
      '401':
        $ref: '../responses/Unauthorized.yaml'

# Get Payment by ID
getPaymentById:
  get:
    operationId: getPaymentById
    tags:
      - Payments
    summary: Get specific payment details
    description: |
      Retrieve detailed information about a specific payment.
      
      **Payment Details Include:**
      - Payment information (amount, status, method)
      - Sponsorship details (if applicable)
      - Enrollment information
      - Free enrollment flag (`is_free_enrollment`)
    security:
      - bearerAuth: []
    parameters:
      - name: id
        in: path
        required: true
        description: Payment ID
        schema:
          type: string
          format: uuid
    responses:
      '200':
        description: Payment details retrieved successfully
        content:
          application/json:
            schema:
              $ref: '../schemas/Payment.yaml'
      '401':
        $ref: '../responses/Unauthorized.yaml'
      '404':
        $ref: '../responses/NotFound.yaml'

# =============================================================================
# ADMIN PAYMENT ENDPOINTS
# =============================================================================

# Get All Payments (Admin)
admin-payments:
  get:
    operationId: admin-payments
    tags:
      - Admin Payments
    summary: Get payment history with admin details
    description: Retrieve comprehensive payment history with admin-level details
    security:
      - bearerAuth: []
    parameters:
      - name: page
        in: query
        description: Page number
        schema:
          type: integer
          default: 1
          minimum: 1
      - name: limit
        in: query
        description: Number of results per page
        schema:
          type: integer
          default: 20
          minimum: 1
          maximum: 100
      - name: status
        in: query
        description: Filter by payment status
        schema:
          type: string
          enum: [successful, failed, pending]
      - name: paymentMethod
        in: query
        description: Filter by payment method
        schema:
          type: string
      - name: search
        in: query
        description: Search by user name or transaction ID
        schema:
          type: string
    responses:
      '200':
        description: Admin payment history retrieved successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                payments:
                  type: array
                  items:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      user_id:
                        type: string
                        format: uuid
                      first_name:
                        type: string
                      last_name:
                        type: string
                      email:
                        type: string
                      amount:
                        type: number
                      currency:
                        type: string
                      status:
                        type: string
                      payment_method:
                        type: string
                      reference:
                        type: string
                      transaction_id:
                        type: string
                      course_title:
                        type: string
                        nullable: true
                      class_title:
                        type: string
                        nullable: true
                      created_at:
                        type: string
                        format: date-time
                pagination:
                  type: object
                  properties:
                    page:
                      type: integer
                    limit:
                      type: integer
                    total:
                      type: integer
                    pages:
                      type: integer
      '401':
        $ref: '../responses/Unauthorized.yaml'
      '403':
        $ref: '../responses/Forbidden.yaml'

# Get Payment Statistics (Admin)
admin-payments-stats:
  get:
    operationId: admin-payments-stats
    tags:
      - Admin Payments
    summary: Get comprehensive payment statistics
    description: Retrieve comprehensive payment statistics for admin dashboard
    security:
      - bearerAuth: []
    parameters:
      - name: period
        in: query
        description: Time period in days
        schema:
          type: integer
          default: 30
          minimum: 1
    responses:
      '200':
        description: Payment statistics retrieved successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                overview:
                  type: object
                  properties:
                    total_payments:
                      type: integer
                      description: Total number of payments
                    total_revenue:
                      type: number
                      description: Total revenue generated
                    successful_payments:
                      type: integer
                      description: Number of successful payments
                    failed_payments:
                      type: integer
                      description: Number of failed payments
                    pending_payments:
                      type: integer
                      description: Number of pending payments
                    average_payment:
                      type: number
                      description: Average payment amount
                methodBreakdown:
                  type: array
                  items:
                    type: object
                    properties:
                      payment_method:
                        type: string
                        description: Payment method used
                      count:
                        type: integer
                        description: Number of payments using this method
                      total_amount:
                        type: number
                        description: Total amount processed through this method
                dailyStats:
                  type: array
                  items:
                    type: object
                    properties:
                      date:
                        type: string
                        format: date
                        description: Date in YYYY-MM-DD format
                      payment_count:
                        type: integer
                        description: Number of payments on this date
                      daily_revenue:
                        type: number
                        description: Revenue generated on this date
      '401':
        $ref: '../responses/Unauthorized.yaml'
      '403':
        $ref: '../responses/Forbidden.yaml' 